# 垃圾回收

当不需要某个东西时，JavaScript引擎如何发现并清理之。

可达性（Reachablity）
---
可达性是JavaScript中主要的内存管理概念。

以下值不能被释放：
- 当前函数的局部变量和参数
- 嵌套调用时，当前调用链上所有的函数的变量与参数
- 全局变量
- 等等

这些值被称作**根（roots）**

垃圾回收器
---
垃圾回收器在后台执行，监控所有对象的状态，并删除已经不可达的。

内部算法
---
垃圾回收的基本算法被称为“mark-and-sweep”。

定期执行“垃圾回收”步骤：
1. 垃圾收集器找到所有根，并“标记”（记住）他们。
2. 然后遍历并“标记”来自他们的所有引用。
3. 然后遍历标记的对象并标记对象的引用。所有被被遍历到的对象都会被记住，以免再次遍历到同一个对象
4. ……如此操作，知道所有可达的（从根部）引用都被访问到。
5. 没有被标记的对象都会被删除。

优化建议
---
- **分代收集（Generational collection）**—— 对象被分成两组：“新的”和“旧的”。许多对象出现，完成他们的工作并很快死去，他们可以很快被清理。那些长期存活的对象会变得“老旧”，而且被检查的频次也会减少。
- **增量收集（Incremental collection）**—— 如果有许多对象，并且我们试图一次遍历并标记整个对象集，则可能需要一些时间，并在执行过程中带来明显的延迟。所以引擎试图将垃圾收集工作分成几部分来做。然后将这几部分会逐一进行处理。这需要他们之间有额外的标记来追踪变化，但是这样会有许多微小的延迟而不是一个大的延迟。
- **闲时收集（Idle-time collection）**—— 垃圾收集器只会在 CPU 空闲时尝试运行，以减少可能对代码执行的影响。


拓展
---
现代引擎实现了垃圾回收的高级算法。

《The Garbage Collection Handbook: The Art of Automatic Memory Management》（R. Jones 等人著）这本书涵盖了其中一些内容。

如果你熟悉底层（low-level）编程，关于 V8 引擎垃圾回收器的更详细信息请参阅文章 V8 之旅：垃圾回收。

V8 博客 还不时发布关于内存管理变化的文章。当然，为了学习垃圾收集，你最好通过学习 V8 引擎内部知识来进行准备，并阅读一个名为 Vyacheslav Egorov 的 V8 引擎工程师的博客。我之所以说 “V8”，因为网上关于它的文章最丰富的。对于其他引擎，许多方法是相似的，但在垃圾收集上许多方面有所不同。

当你需要底层的优化时，对引擎有深入了解将很有帮助。在熟悉了这门编程语言之后，把熟悉引擎作为下一步计划是明智之选。